<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checklist de Alquiler (AR) — Preguntas + Respuestas</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --ink:#e5e7eb;   /* gray-200 */
      --accent:#22d3ee;/* cyan-400 */
      --ok:#10b981;    /* emerald-500 */
      --warn:#f59e0b;  /* amber-500 */
      --danger:#ef4444;/* red-500 */
      --border:#1f2937;/* gray-800 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      background:var(--bg); color:var(--ink);
    }
    header{position:sticky; top:0; z-index:50; background:rgba(15,23,42,.9); backdrop-filter: blur(6px); border-bottom:1px solid var(--border)}
    .wrap{max-width:1000px; margin:auto; padding:16px}
    h1{margin:8px 0 4px; font-size: clamp(22px, 3vw, 34px)}
    .sub{color:var(--muted); font-size:14px}
    .grid{display:grid; grid-template-columns: 1fr; gap:16px}
    @media(min-width:900px){.grid{grid-template-columns: 1fr 1fr}}
    section.card{border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); border-radius:14px; padding:16px}
    section.card h2{margin:0 0 8px; font-size:18px; color:#fff}
    .q{margin:10px 0; padding-top:8px; border-top:1px dashed var(--border)}
    label{display:block; font-weight:600; margin:0 0 6px}
    .hint{color:var(--muted); font-size:12px; margin: 2px 0 8px}
    textarea{width:100%; min-height:72px; resize:vertical; background:#0b1220; color:#e5e7eb; border:1px solid var(--border); border-radius:10px; padding:10px}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:12px 0}
    button{cursor:pointer; border:1px solid var(--border); background:#0b1220; color:#e5e7eb; padding:10px 12px; border-radius:10px; font-weight:600}
    button:hover{opacity:0.9}
    button.primary{background:var(--accent); color:#001018; border-color:transparent}
    button.ok{background:var(--ok); color:#072b1b; border-color:transparent}
    button.warn{background:var(--warn); color:#1c1400; border-color:transparent}
    button.danger{background:var(--danger); color:#2a0707; border-color:transparent}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .progress{height:10px; background:#0b1220; border:1px solid var(--border); border-radius:999px; overflow:hidden; flex:1}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #60a5fa); transition: width 0.3s ease}
    .pill{font-size:12px; color:var(--muted)}
    footer{color:var(--muted); font-size:12px; text-align:center; padding:24px}
    .note{font-size:12px; color:var(--muted)}
    details{border:1px dashed var(--border); border-radius:10px; padding:8px 10px}
    summary{cursor:pointer; font-weight:700}
    .add{display:flex; gap:8px; margin-top:8px}
    input[type="text"]{width:100%; background:#0b1220; color:#e5e7eb; border:1px solid var(--border); border-radius:10px; padding:10px}
    .tag{display:inline-block; font-size:11px; color:#0d1b2a; background:var(--accent); padding:2px 8px; border-radius:999px; margin-left:8px}
    .banner{display:none; margin-top:8px; padding:10px; border:1px dashed var(--border); border-radius:10px; color:#eab308;}
    
    /* Mejoras para GitHub Pages */
    @media (max-width: 768px) {
      .wrap { padding: 12px; }
      .toolbar { justify-content: center; }
      button { min-width: 120px; font-size: 14px; }
      .row { flex-direction: column; align-items: stretch; gap: 8px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div>
          <h1>Checklist de Alquiler (Argentina)</h1>
          <div class="sub">Preguntas clave + caja para anotar respuestas. Guarda todo <strong>en tu navegador</strong> (local) automáticamente.</div>
          <div id="statusBanner" class="banner" aria-live="polite"></div>
        </div>
        <div class="row" style="gap:8px">
          <button class="primary" id="exportJson" data-testid="btn-export-json">Exportar respuestas (.json)</button>
          <button class="ok" id="exportTxt" data-testid="btn-export-txt">Exportar (.txt)</button>
          <button class="warn" id="printIt" data-testid="btn-print">Imprimir</button>
          <button class="danger" id="clearAll" data-testid="btn-clear">Limpiar todo</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="pill"><span id="count">0</span>/<span id="total">0</span> respondidas</div>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:12px">

    <details style="margin-bottom:16px"><summary>Consejo rápido</summary>
      <div class="note">Escribí corto y claro. Si algo debe quedar por contrato, marcá la respuesta con <strong>[PONER EN CONTRATO]</strong> para no olvidarlo. Podés añadir tus propias preguntas al final.</div>
    </details>

    <div class="grid" id="sections"><!-- JS injects sections here --></div>

    <section class="card">
      <h2>Agregar pregunta propia <span class="tag">Personalizable</span></h2>
      <div class="add">
        <input id="customQuestion" type="text" placeholder="Escribí tu pregunta" />
        <button id="addQuestion" data-testid="btn-add-q">Agregar</button>
      </div>
    </section>

    <section class="card" id="testRunner" aria-live="polite">
      <h2>Test Runner <span class="tag">Diagnóstico</span></h2>
      <div class="note">Úsalo si algo falla. No cambia tus datos.</div>
      <div class="toolbar">
        <button id="runTests" class="ok" data-testid="btn-run-tests">Ejecutar tests</button>
        <button id="resetFactory" class="danger" data-testid="btn-reset">Restablecer (de fábrica)</button>
      </div>
      <pre id="testOutput" style="background:#0b1220; border:1px solid var(--border); border-radius:10px; padding:12px; overflow:auto; max-height:260px"></pre>
    </section>

  </main>

  <footer>
    Hecho por y para inquilinos en AR. Tus datos quedan en tu dispositivo (LocalStorage o memoria local si el navegador lo bloquea).
  </footer>

  <script>
  'use strict';
  (function(){
    // ---- Error guards for noisy environments ----
    function isMetaMaskMessage(msg){
      if(!msg) return false;
      try{ return /metamask|failed to connect to metamask/i.test(String(msg)); }catch(_){ return false; }
    }
    
    window.addEventListener('error', function(e){
      if(isMetaMaskMessage(e && e.message)){
        e.preventDefault();
        console.info('[Guard] Error externo filtrado:', e.message);
      }
    });
    
    window.addEventListener('unhandledrejection', function(e){
      const reason = e && (e.reason && (e.reason.message || e.reason)) || '';
      if(isMetaMaskMessage(reason)){
        e.preventDefault();
        console.info('[Guard] Promesa externa filtrada:', reason);
      }
    });

    // ---- Safe storage wrapper ----
    const DATA_KEY = 'alquiler_ar_checklist_v1';
    const memoryStore = {};
    
    const storage = {
      available: true,
      get: function(key){
        try{ 
          return window.localStorage ? window.localStorage.getItem(key) : null; 
        }catch(_){ 
          this.available = false; 
          return memoryStore[key] || null; 
        }
      },
      set: function(key, val){
        try{ 
          if(window.localStorage) {
            window.localStorage.setItem(key, val); 
            this.available = true; 
          } else {
            throw new Error('localStorage no disponible');
          }
        }
        catch(_){ 
          this.available = false; 
          memoryStore[key] = val; 
        }
      },
      remove: function(key){
        try{ 
          if(window.localStorage) {
            window.localStorage.removeItem(key); 
          }
        }
        catch(_){ 
          delete memoryStore[key]; 
        }
      },
      clear: function(){
        try{ 
          if(window.localStorage) {
            window.localStorage.removeItem(DATA_KEY); 
          }
        }
        catch(_){ 
          for(const k in memoryStore) {
            if(memoryStore.hasOwnProperty(k)) {
              delete memoryStore[k];
            }
          }
        }
      }
    };

    // ---- Schema (questions) ----
    const schema = [
      {title:'Contrato y moneda', qs:[
        '¿En qué moneda está el alquiler? ¿ARS o USD?',
        'Si es en USD, ¿aceptan pago en pesos? ¿A qué tipo de cambio exacto?',
        '¿Cada cuánto ajusta y con qué índice está escrito?',
        '¿Cuál es el plazo exacto del contrato (inicio/fin)?'
      ]},
      {title:'Costos y comisiones', qs:[
        '¿Cuánto piden de depósito y cómo/ cuándo lo devuelven?',
        '¿Quién paga comisión inmobiliaria y de cuánto es?',
        '¿Qué impuestos/tasas pago yo y cuáles paga el dueño?'
      ]},
      {title:'Expensas y servicios', qs:[
        '¿Expensas ordinarias a mi cargo? ¿Y extraordinarias?',
        'Mostrame la última liquidación de expensas y si hay deudas.',
        '¿Quién transfiere luz, gas, agua e internet y desde cuándo pago yo?'
      ]},
      {title:'Garantías', qs:[
        '¿Qué garantías aceptan? (propietaria, seguro de caución, recibos de sueldo)',
        'Para caución: ingresos mínimos, costo anual y qué cubre (alquiler/expensas/daños)'
      ]},
      {title:'Estado del inmueble', qs:[
        '¿Puedo probar gas, electricidad, agua y calefacción en vivo?',
        '¿Entregan inventario con fotos, medidores y estado de artefactos?',
        '¿Hay humedad/filtraciones previas o arreglos recientes?'
      ]},
      {title:'Reparaciones y mantenimiento', qs:[
        '¿Quién paga qué reparación y tiempos de respuesta en urgencias?',
        'Si no responden, ¿puedo reparar y descontar hasta un tope acordado?'
      ]},
      {title:'Reglas y uso', qs:[
        '¿Se permiten mascotas y hay restricciones de ruidos/horarios?',
        '¿Puedo trabajar desde casa (creador de contenido/home office)?',
        '¿Depósito/bicicletero/baulera incluidos? ¿Cochera y costo?'
      ]},
      {title:'Rescisión, mora y entrega', qs:[
        '¿Cláusula de salida anticipada (penalidad y preaviso)?',
        '¿Intereses por mora y días de gracia?',
        'Criterios de "daño" al devolver (cómo se evalúa)'
      ]},
      {title:'Forma de pago y respaldo', qs:[
        '¿Cómo pago (transferencia, billetera, efectivo) y quién emite recibo/factura?',
        '¿Se registra algo ante AFIP? (igual quiero contrato y recibos)'
      ]},
      {title:'Alquiler temporario (si aplica)', qs:[
        '¿Está permitido por reglamento/municipio y está registrado si corresponde?',
        '¿Condiciones exactas de estadía, limpieza, gastos y renovaciones?'
      ]}
    ];

    // ---- State ----
    function loadState(){
      var raw = storage.get(DATA_KEY);
      if(!raw){ return {}; }
      try { return JSON.parse(raw) || {}; } catch(_) { return {}; }
    }
    
    var state = loadState();

    function saveState(){
      try { 
        storage.set(DATA_KEY, JSON.stringify(state)); 
      }
      catch(_) { 
        // ignored, memory fallback already used 
      }
    }

    // ---- Utilities ----
    function qId(sectionTitle, idx){
      return sectionTitle.toLowerCase().replace(/[^a-z0-9]+/g,'-') + "__" + idx;
    }

    function serializeToJson(){
      var payload = { 
        createdAt: new Date().toISOString(), 
        data: {} 
      };
      var textareas = document.querySelectorAll('textarea');
      for(var i = 0; i < textareas.length; i++){
        var t = textareas[i];
        payload.data[t.id] = t.value;
      }
      return JSON.stringify(payload, null, 2);
    }
    
    function serializeToText(){
      var lines = [];
      for(var s = 0; s < schema.length; s++){
        var block = schema[s];
        lines.push('# ' + block.title);
        for(var q = 0; q < block.qs.length; q++){
          var question = block.qs[q];
          var id = qId(block.title, q);
          lines.push('\n• ' + question + '\n' + (state[id] || '') + '\n');
        }
        lines.push('\n');
      }
      return lines.join('\n');
    }

    function download(filename, text){
      try{
        var blob = new Blob([text], {type:'text/plain;charset=utf-8'});
        var url = URL.createObjectURL(blob);
        var el = document.createElement('a');
        el.href = url; 
        el.download = filename; 
        el.style.display = 'none';
        document.body.appendChild(el); 
        el.click(); 
        el.remove();
        URL.revokeObjectURL(url);
      }catch(_){
        // Fallback to data URL
        var el = document.createElement('a');
        el.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        el.setAttribute('download', filename);
        el.style.display = 'none';
        document.body.appendChild(el);
        el.click();
        el.remove();
      }
    }

    function updateProgress(){
      var all = document.querySelectorAll('textarea');
      var total = all.length;
      var answered = 0;
      for(var i = 0; i < all.length; i++){
        if(all[i].value.trim().length) answered++;
      }
      var pct = total ? Math.round((answered/total)*100) : 0;
      document.getElementById('count').textContent = answered;
      document.getElementById('total').textContent = total;
      document.getElementById('bar').style.width = pct + '%';
    }

    function render(){
      var container = document.getElementById('sections');
      container.innerHTML = '';
      
      for(var s = 0; s < schema.length; s++){
        var block = schema[s];
        var sec = document.createElement('section');
        sec.className = 'card';
        var h = document.createElement('h2'); 
        h.textContent = block.title; 
        sec.appendChild(h);
        
        for(var q = 0; q < block.qs.length; q++){
          var question = block.qs[q];
          var id = qId(block.title, q);
          var val = state[id] || '';
          var wrap = document.createElement('div'); 
          wrap.className = 'q';
          var label = document.createElement('label'); 
          label.setAttribute('for', id); 
          label.textContent = question; 
          wrap.appendChild(label);
          var hint = document.createElement('div'); 
          hint.className = 'hint'; 
          hint.textContent = 'Respuesta / acuerdos / cosas para poner en contrato'; 
          wrap.appendChild(hint);
          var ta = document.createElement('textarea'); 
          ta.id = id; 
          ta.placeholder = 'Escribí la respuesta aquí…'; 
          ta.value = val;
          
          ta.addEventListener('input', function(e){
            state[e.target.id] = e.target.value; 
            saveState(); 
            updateProgress(); 
          });
          
          wrap.appendChild(ta);
          sec.appendChild(wrap);
        }
        container.appendChild(sec);
      }
      
      updateProgress();
      
      // Banner
      var banner = document.getElementById('statusBanner');
      if(!storage.available){
        banner.style.display = 'block';
        banner.textContent = 'Aviso: LocalStorage está bloqueado. Se usará memoria temporal (se borrará al cerrar).';
      } else {
        banner.style.display = 'none';
      }
    }

    function addCustomQuestion(){
      var input = document.getElementById('customQuestion');
      var text = (input.value || '').trim();
      if(!text) return;
      
      var hasPersonal = false;
      for(var i = 0; i < schema.length; i++){
        if(schema[i].title === 'Personalizadas'){
          hasPersonal = true;
          break;
        }
      }
      
      if(!hasPersonal) {
        schema.push({title:'Personalizadas', qs:[]});
      }
      
      var idx = -1;
      for(var i = 0; i < schema.length; i++){
        if(schema[i].title === 'Personalizadas'){
          idx = i;
          break;
        }
      }
      
      if(idx >= 0){
        schema[idx].qs.push(text);
      }
      
      input.value = '';
      render();
      window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
    }

    // ---- Event wiring ----
    function bindUI(){
      document.getElementById('exportJson').addEventListener('click', function(){ 
        download('respuestas_alquiler.json', serializeToJson()); 
      });
      
      document.getElementById('exportTxt').addEventListener('click', function(){ 
        download('respuestas_alquiler.txt', serializeToText()); 
      });
      
      document.getElementById('printIt').addEventListener('click', function(){ 
        window.print(); 
      });
      
      document.getElementById('clearAll').addEventListener('click', function(){
        if(confirm('Esto borrará todas las respuestas guardadas en este navegador. ¿Continuar?')){
          storage.clear();
          for(var k in state) {
            if(state.hasOwnProperty(k)){
              delete state[k];
            }
          }
          render();
        }
      });
      
      document.getElementById('addQuestion').addEventListener('click', addCustomQuestion);
      
      document.getElementById('customQuestion').addEventListener('keypress', function(e){
        if(e.key === 'Enter'){
          addCustomQuestion();
        }
      });
      
      // Tests
      document.getElementById('runTests').addEventListener('click', runTests);
      document.getElementById('resetFactory').addEventListener('click', function(){
        storage.clear();
        for(var k in state) {
          if(state.hasOwnProperty(k)){
            delete state[k];
          }
        }
        render();
        logTest('Restablecido a valores de fábrica.');
      });
    }

    // ---- Simple test harness ----
    var out = document.getElementById('testOutput');
    function logTest(msg){ out.textContent += msg + "\n"; }
    function assert(cond, msg){ 
      if(!cond) throw new Error('❌ ' + msg); 
      logTest('✅ ' + msg); 
    }

    function countTotalQuestions(){
      var total = 0;
      for(var i = 0; i < schema.length; i++){
        total += schema[i].qs.length;
      }
      return total;
    }

    function runTests(){
      out.textContent = '';
      try{
        // Test 1: Storage availability fallback works
        state['test__key'] = 'valor-prueba';
        saveState();
        assert(true, 'Storage guarda sin lanzar excepción (fallback si está bloqueado).');
        
        // Test 2: Render creates all textareas
        render();
        var textareas = document.querySelectorAll('textarea');
        assert(textareas.length === countTotalQuestions(), 'Render crea ' + textareas.length + ' textareas (coincide con el esquema).');
        
        // Test 3: Add custom question increases count
        var prev = textareas.length;
        document.getElementById('customQuestion').value = '¿Pregunta personalizada de prueba?';
        addCustomQuestion();
        var now = document.querySelectorAll('textarea').length;
        assert(now === prev + 1, 'Agregar pregunta propia incrementa el total.');
        
        // Test 4: Serializadores devuelven texto no vacío
        var json = serializeToJson();
        var txt = serializeToText();
        assert(!!json && json.length > 10, 'serializeToJson produce contenido.');
        assert(!!txt && txt.length > 10, 'serializeToText produce contenido.');
        
        // Test 5: Progress updates
        var beforePct = document.getElementById('bar').style.width;
        var anyTa = document.querySelector('textarea'); 
        if(anyTa) {
          anyTa.value = 'algo'; 
          anyTa.dispatchEvent(new Event('input'));
        }
        var afterPct = document.getElementById('bar').style.width;
        assert(beforePct !== afterPct, 'La barra de progreso reacciona a cambios.');
        
        logTest('\nTodas las pruebas pasaron.');
      }catch(err){
        logTest(String(err && err.message || err));
      }
    }

    // ---- Init ----
    function init(){
      // Asegurar que el DOM esté cargado
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', function(){
          bindUI();
          render();
        });
      } else {
        bindUI();
        render();
      }
    }
    
    init();
  })();
  </script>
</body>
</html>
